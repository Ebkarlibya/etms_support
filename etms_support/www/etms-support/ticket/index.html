{% block head_include %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}
<div class="replay-page" style="direction: ltr; " d="{{ 'rtl' if frappe.lang == 'en' }}">
    <div class="row">
        <div class="col-md-8">
            <!-- Header -->
            <a href="/etms-support/tickets" class="font-size-sm d-block mb-8 text-muted">‚Üê Back to Support Tickets</a>
            <div class="replay-header">
                <h5>{{ticket.name}}</h5>
                <div style="text-align: center;">
                    <h5 style="margin-bottom: 5px;">{{ticket.subject}}</h5>
                    {% if ticket.status == "Open" %}
                    <span class="badge badge-success">{{ticket.status}}</span>
                    {% elif ticket.status == "Waiting Replay" %}
                    <span class="badge badge-warning">{{ticket.status}}</span>
                    {% else %}
                    <span class="badge badge-danger">{{ticket.status}}</span>
                    {% endif %}
                    
                </div>
            </div>
            <!-- <p class="badge badge-secondary">{{ticket.issue_type}}</p><br> -->
            {% for att in attachments %}
                {% if att.file_url.endswith(".webm") %}
                    <button type="button" class="btn btn-warning btn-sm" onclick="playAudio('{{att.file_url}}')">
                        <i class="bi bi-play"></i>
                    </button>
                {% else %}
                    <a href="{{ att.file_url }}" target="_blank">
                        <button type="button" class="btn btn-warning btn-sm">
                            <i class="bi bi-paperclip"></i>
                        </button>
                    </a>
                {%endif%}
            {% endfor %}
            <!-- first replay, ticket details -->
            <div class="mt-8">
                <div class="media">
                    <img class="profile-image-first" src="{{user_details.user_image}}" class="mr-3 rounded-circle"
                        alt="{{ full_name }}">
                    <div class="media-body">
                        <div class="d-flex justify-content-between align-items-baseline">
                            <h6 class="mb-4 mt-3 badge badge-secondary">{{user_details.full_name}}</h6>
                            <div class="font-size-sm text-muted">{{ticket.creation.strftime("%b %d, %Y, %H:%M %p")}}
                            </div>
                        </div>
                        <div class="d-flex rounded px-4 pt-2 pb-5 text-bubble" data-darkreader-inline-bgcolor="">
                            <p>{{ticket.description}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- comments list -->
            {% for comment in comments %}
            <div class="mt-8">
                <div class="media">
                    <img class="profile-image" src="{{comment.user_details.user_image}}" class="mr-3 rounded-circle">
                    <div class="media-body">
                        <div class="d-flex justify-content-between align-items-baseline">
                            <h6 class="mb-4 mt-3 badge badge-secondary">{{ comment.user_details.full_name }}</h6>
                            <div class="font-size-sm text-muted">{{comment.creation.strftime("%b %d, %Y, %H:%M %p")}}
                            </div>
                        </div>
                        <div class="d-flex justify-content-between rounded px-4 pt-2 pb-5 text-bubble" data-darkreader-inline-bgcolor="">
                            <p>{{comment.content}}</p>
                            <div class="att-container">
                                {% for att in comment.comment_attachments %}
                                    {% if att.file_url.endswith(".webm") %}
                                        <button type="button" class="btn btn-warning btn-sm" onclick="playAudio('{{att.file_url}}')"
                                            style="height: 30px;">
                                            <i class="bi bi-play"></i>
                                        </button>
                                    {% else %}
                                        <a href="{{ att.file_url }}" target="_blank">
                                            <button type="button" class="btn btn-warning btn-sm" style="height: 30px; margin-left: 10px;">
                                                <i class="bi bi-paperclip"></i>
                                            </button>
                                        </a>
                                    {%endif%}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if ticket.status != "Closed" %}
            <!-- replay box -->
            <div class="input-form replay-box">
                <div class="form-group mb-10">
                    <label for="etms-replay-textarea">{{_("Your replay")}}</label>
                    <textarea id="etms-replay-textarea" cols="30" rows="40" class="form-control input-lg"
                    style="height: 200px;"></textarea>                    
                    <div class="etms-audio-recorder mt-3">
                        <!-- <div class="clearfix">
                            <label class="control-label" style="padding-right: 0px;">Attach Media</label>
                        </div> -->
                        <input type="file" id="etms-attach-file" style="display: none;">
                        <button class="btn btn-default etms-play-btn" hidden type="button">
                            <i class="bi bi-play-fill"></i>
                        </button>
    
                        <button class="btn btn-default etms-record-btn" type="button">
                            <i class="bi bi-mic-fill"></i>
                        </button>
                        <!-- bi bi-stop-fill -->
                        <button class="btn btn-default etms-trash-btn" hidden type="button">
                            <i class="bi bi-trash"></i>
                        </button>
                        <span class="vertical-divider"></span>
                        <input type="file" id="etms-attach-file" style="display: none;">
                        <button class="btn btn-default etms-attach-btn" type="button">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <!-- <div class="etms-spinner" style="display: inline-block; padding-left: 30px;">
                            <div class="spinner-border spinner-border text-success" role="status">
                            </div>
                        </div> -->
                        <p class="etms-recorder-timer"></p>
                        <p class="help-box small text-muted"></p>
                    </div>
                        
                </div>
                <div class="form-group replay-box__buttons">
                    <button class="btn btn-primary mr-10" id="etms-submit-replay"
                        style="margin-right: 8px;">{{_("Replay")}}</button>

                    <button class="btn btn-danger btn-sm" id="etms-close-ticket" style="height: 30px;">{{_("Close
                        Ticket")}}</button>

                </div>

                <div class="alert alert-success" hidden></div>
                <div class="alert alert-danger" hidden></div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .ticket-page {
        margin-top: 50px;
    }

    .replay-header {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: baseline;
    }

    .replay-box {
        margin-top: 60px;
    }
    .replay-box__buttons {
        display: flex;
        justify-content: space-between;
    }
    .profile-image-first {
        width: 4rem;
        height: 4rem;
        object-fit: fill;
        border-radius: 6px;
        border: solid gray 2px;
        margin: 0px 8px 0px 0px;
        box-shadow: deeppink;
        box-shadow: 0 5px 16px rgb(0 109 0 / 15%);
    }

    .profile-image {
        width: 3.3rem;
        height: 3.3rem;
        object-fit: fill;
        border-radius: 6px;
        border: solid gray 2px;
        margin: 0px 8px 0px 0px;
        box-shadow: deeppink;
        box-shadow: 0 5px 16px rgb(0 109 0 / 15%);
    }

    .text-bubble {
        position: relative;
        background-color: #e6f2ff;
        --darkreader-inline-bgcolor: var(--darkreader-bg--gray-100);
    }
    .vertical-divider {
        display: inline-block;
        border-right: 1px solid gray;
        height: 24px;
        margin: 0px 10px -8px 10px;
    }
    .att-container {
        position: absolute;
        right: 19px;
        top: 49px;
    }
</style>